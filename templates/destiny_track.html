<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å‘½è¿è½¨è¿¹ - åŸºäºå…«å­—çš„äººç”Ÿæ¨¡æ‹Ÿ</title>
    <!-- Markdownè§£æåº“ -->
    <script src="https://cdn.jsdelivr.net/npm/marked@9.1.6/marked.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Microsoft YaHei', Arial, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
            overflow: hidden;
        }
        
        .header {
            background: linear-gradient(45deg, #FF6B6B, #4ECDC4);
            color: white;
            padding: 30px;
            text-align: center;
        }
        
        .header h1 {
            font-size: 2.5em;
            margin-bottom: 10px;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
        }
        
        .header p {
            font-size: 1.1em;
            opacity: 0.9;
        }
        
        .main-content {
            display: flex;
            min-height: calc(100vh - 200px);
        }

        .sidebar {
            width: 320px;
            background: #f8f9fa;
            padding: 20px;
            border-right: 2px solid #dee2e6;
            overflow-y: hidden;
            display: flex;
            flex-direction: column;
            height: calc(100vh - 200px);
        }
        
        .bazi-info {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 15px;
            border-radius: 12px;
            margin-bottom: 15px;
            flex-shrink: 0;
        }
        
        .bazi-info h3 {
            margin-bottom: 15px;
            font-size: 1.2em;
        }
        
        .info-item {
            margin: 6px 0;
            padding: 3px 0;
            border-bottom: 1px solid rgba(255,255,255,0.2);
        }

        .life-stages-container {
            flex: 1;
            overflow-y: auto;
            margin-bottom: 15px;
        }
        
        .life-stage {
            background: white;
            border: 2px solid #e9ecef;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 15px;
        }
        
        .life-stage.current {
            border-color: #FF6B6B;
            background: linear-gradient(135deg, #FF6B6B 0%, #4ECDC4 100%);
            color: white;
        }
        
        .life-stage h4 {
            margin-bottom: 8px;
            font-size: 1.1em;
        }
        
        .life-stage p {
            font-size: 0.9em;
            opacity: 0.8;
        }
        
        .life-stage:hover {
            background: #f0f0f0;
            cursor: pointer;
            transform: translateX(5px);
            transition: all 0.3s ease;
        }
        
        .life-stage.current:hover {
            transform: translateX(5px);
        }
        
        .ai-config-panel {
            background: linear-gradient(135deg, #fd79a8 0%, #e84393 100%);
            color: white;
            padding: 15px;
            border-radius: 12px;
            margin-bottom: 15px;
            flex-shrink: 0;
        }
        
        .ai-config-panel h4 {
            margin-bottom: 15px;
            text-align: center;
        }
        
        .config-status {
            text-align: center;
            margin-bottom: 15px;
            font-size: 1.1em;
        }
        
        .stats-panel {
            background: linear-gradient(135deg, #74b9ff 0%, #0984e3 100%);
            color: white;
            padding: 15px;
            border-radius: 12px;
            margin-bottom: 15px;
            flex-shrink: 0;
        }
        
        .stats-panel h4 {
            margin-bottom: 15px;
            text-align: center;
        }
        
        .stat-item {
            display: flex;
            justify-content: space-between;
            margin: 8px 0;
            padding: 5px 0;
            border-bottom: 1px solid rgba(255,255,255,0.2);
        }
        
        .control-buttons {
            display: flex;
            gap: 10px;
            flex-shrink: 0;
        }
        
        .control-btn {
            flex: 1;
            background: #6c5ce7;
            color: white;
            border: none;
            padding: 12px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 1em;
            transition: background 0.3s ease;
        }
        
        .control-btn:hover {
            background: #5a4fcf;
        }
        
        .control-btn:disabled {
            background: #ccc;
            cursor: not-allowed;
        }
        
        .game-area {
            flex: 1;
            padding: 30px;
        }
        
        .game-settings {
            background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
            color: white;
            padding: 40px;
            border-radius: 15px;
            text-align: center;
        }
        
        .settings-title {
            font-size: 2em;
            margin-bottom: 30px;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
        }
        
        .settings-content {
            background: rgba(255,255,255,0.1);
            padding: 30px;
            border-radius: 12px;
            margin-bottom: 30px;
        }
        
        .setting-group {
            margin-bottom: 30px;
        }
        
        .setting-group h4 {
            margin-bottom: 20px;
            font-size: 1.4em;
        }
        
        .style-options {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
        }
        
        .style-option {
            cursor: pointer;
        }
        
        .style-option input[type="radio"] {
            display: none;
        }
        
        .option-card {
            background: rgba(255,255,255,0.1);
            padding: 20px;
            border-radius: 12px;
            border: 2px solid transparent;
            transition: all 0.3s ease;
        }
        
        .style-option input[type="radio"]:checked + .option-card {
            border-color: #ffd700;
            background: rgba(255,215,0,0.2);
        }
        
        .option-card:hover {
            background: rgba(255,255,255,0.2);
            transform: translateY(-2px);
        }
        
        .option-icon {
            font-size: 2em;
            margin-bottom: 10px;
        }
        
        .option-title {
            font-size: 1.2em;
            font-weight: bold;
            margin-bottom: 8px;
        }
        
        .option-desc {
            font-size: 0.9em;
            opacity: 0.9;
        }
        
        .time-options {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
        }
        
        .time-option {
            cursor: pointer;
        }
        
        .time-option input[type="radio"] {
            display: none;
        }
        
        .time-card {
            background: rgba(255,255,255,0.1);
            padding: 20px;
            border-radius: 12px;
            border: 2px solid transparent;
            transition: all 0.3s ease;
            text-align: center;
        }
        
        .time-option input[type="radio"]:checked + .time-card {
            border-color: #ffd700;
            background: rgba(255,215,0,0.2);
        }
        
        .time-card:hover {
            background: rgba(255,255,255,0.2);
            transform: translateY(-2px);
        }
        
        .time-icon {
            font-size: 2em;
            margin-bottom: 10px;
        }
        
        .time-title {
            font-size: 1.1em;
            font-weight: bold;
            margin-bottom: 8px;
        }
        
        .time-desc {
            font-size: 0.9em;
            opacity: 0.9;
        }
        
        .setting-actions {
            text-align: center;
        }
        
        .start-game-btn {
            background: linear-gradient(45deg, #4ECDC4, #44A08D);
            color: white;
            border: none;
            padding: 15px 40px;
            border-radius: 25px;
            font-size: 1.2em;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 4px 15px rgba(0,0,0,0.2);
        }
        
        .start-game-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(0,0,0,0.3);
        }
        
        .story-section {
            background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
            color: white;
            padding: 25px;
            border-radius: 12px;
            margin-bottom: 25px;
            box-shadow: 0 8px 32px rgba(240, 147, 251, 0.3);
        }
        
        .story-title {
            font-size: 1.5em;
            margin-bottom: 15px;
            text-align: center;
        }
        
        .story-content {
            background: rgba(255,255,255,0.1);
            padding: 20px;
            border-radius: 8px;
            line-height: 1.8;
            margin-bottom: 20px;
        }
        
        .story-content h1, .story-content h2, .story-content h3 {
            color: #fff;
            margin: 15px 0 10px 0;
        }
        
        .story-content p {
            margin: 10px 0;
        }
        
        .story-content strong {
            color: #ffd700;
        }
        
        .story-content em {
            color: #ffc0cb;
        }
        
        .choices-section {
            background: white;
            padding: 25px;
            border-radius: 12px;
            box-shadow: 0 4px 16px rgba(0,0,0,0.1);
        }
        
        .choices-title {
            font-size: 1.3em;
            color: #333;
            margin-bottom: 20px;
            text-align: center;
            font-weight: bold;
        }
        
        .choice-button {
            width: 100%;
            background: linear-gradient(45deg, #667eea, #764ba2);
            color: white;
            border: none;
            padding: 15px 20px;
            margin: 10px 0;
            border-radius: 8px;
            cursor: pointer;
            font-size: 1em;
            text-align: left;
            transition: transform 0.3s ease, box-shadow 0.3s ease;
            position: relative;
        }
        
        .choice-button:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(102, 126, 234, 0.3);
        }
        
        .choice-button:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
        }
        
        .choice-number {
            display: inline-block;
            background: rgba(255,255,255,0.2);
            border-radius: 50%;
            width: 25px;
            height: 25px;
            text-align: center;
            line-height: 25px;
            margin-right: 10px;
            font-weight: bold;
        }
        
        .loading {
            text-align: center;
            padding: 40px;
            color: #6c5ce7;
            font-size: 1.2em;
        }
        
        .loading-spinner {
            display: inline-block;
            width: 30px;
            height: 30px;
            border: 3px solid #f3f3f3;
            border-top: 3px solid #6c5ce7;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-right: 10px;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        @keyframes blink {
            0%, 50% { opacity: 1; }
            51%, 100% { opacity: 0; }
        }
        
        .history-panel {
            background: linear-gradient(135deg, #a29bfe 0%, #6c5ce7 100%);
            color: white;
            padding: 20px;
            border-radius: 12px;
            margin-top: 20px;
            max-height: 300px;
            overflow-y: auto;
        }
        
        .history-panel h4 {
            margin-bottom: 15px;
            text-align: center;
            border-bottom: 2px solid rgba(255,255,255,0.3);
            padding-bottom: 10px;
        }
        
        .history-item {
            background: rgba(255,255,255,0.1);
            padding: 12px;
            margin: 10px 0;
            border-radius: 8px;
            border-left: 4px solid rgba(255,255,255,0.5);
        }
        
        .history-item-title {
            font-weight: bold;
            margin-bottom: 5px;
            font-size: 0.9em;
        }
        
        .history-item-choice {
            font-size: 0.85em;
            opacity: 0.9;
            background: rgba(255,255,255,0.1);
            padding: 5px 8px;
            border-radius: 4px;
            margin-top: 5px;
        }
        
        .history-item-age {
            font-size: 0.8em;
            opacity: 0.7;
            text-align: right;
            margin-top: 5px;
        }
        
        .empty-history {
            text-align: center;
            opacity: 0.7;
            font-style: italic;
            padding: 20px 0;
        }
        
        /* å³ä¾§æµ®åŠ¨äººç”Ÿè½¨è¿¹é¢æ¿ */
        .trajectory-panel {
            position: fixed;
            top: 100px;
            right: 20px;
            width: 280px;
            max-height: calc(100vh - 140px);
            background: rgba(255, 255, 255, 0.95);
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
            z-index: 1000;
            overflow-y: auto;
            padding: 20px;
            backdrop-filter: blur(10px);
        }
        
        /* æ¨¡æ€æ¡†æ ·å¼ */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.8);
            z-index: 2000;
            align-items: center;
            justify-content: center;
            padding: 20px;
        }
        
        .modal-content {
            background: white;
            border-radius: 15px;
            max-width: 500px;
            width: 100%;
            max-height: 80vh;
            overflow-y: auto;
            position: relative;
        }
        
        .modal-header {
            background: linear-gradient(45deg, #667eea, #764ba2);
            color: white;
            padding: 20px 30px;
            border-radius: 15px 15px 0 0;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .modal-header h3 {
            margin: 0;
            font-size: 1.3em;
        }
        
        .close-btn {
            background: none;
            border: none;
            color: white;
            font-size: 1.5em;
            cursor: pointer;
            padding: 0;
            width: 30px;
            height: 30px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 50%;
            transition: background 0.3s ease;
        }
        
        .close-btn:hover {
            background: rgba(255,255,255,0.2);
        }
        
        .modal-body {
            padding: 30px;
        }
        
        .form-group {
            margin-bottom: 20px;
        }
        
        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: bold;
            color: #333;
        }
        
        .form-group input,
        .form-group select,
        .form-group textarea {
            width: 100%;
            padding: 12px;
            border: 2px solid #e1e8ed;
            border-radius: 8px;
            font-size: 1em;
            transition: border-color 0.3s ease;
            box-sizing: border-box;
        }
        
        .form-group input:focus, .form-group select:focus, .form-group textarea:focus {
            outline: none;
            border-color: #4ECDC4;
            box-shadow: 0 0 0 3px rgba(78, 205, 196, 0.1);
        }
        
        .modal-footer {
            padding: 20px 30px;
            border-top: 1px solid #eee;
            display: flex;
            gap: 15px;
            justify-content: flex-end;
        }
        
        .modal-btn {
            padding: 12px 25px;
            border: none;
            border-radius: 8px;
            font-size: 1em;
            cursor: pointer;
            transition: background 0.3s ease;
        }
        
        .modal-btn.cancel {
            background: #6c757d;
            color: white;
        }
        
        .modal-btn.cancel:hover {
            background: #5a6268;
        }
        
        .modal-btn.save {
            background: linear-gradient(45deg, #FF6B6B, #4ECDC4);
            color: white;
        }
        
        .modal-btn.save:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 15px rgba(0,0,0,0.2);
        }
        
        @media (max-width: 768px) {
            .main-content {
                flex-direction: column;
            }
            
            .sidebar {
                width: 100%;
                border-right: none;
                border-bottom: 2px solid #dee2e6;
            }
            
            .trajectory-panel {
                position: relative;
                right: auto;
                top: auto;
                width: 100%;
                max-height: 300px;
                margin-top: 20px;
            }
            
            .container {
                margin: 10px;
                border-radius: 10px;
            }
            
            .header h1 {
                font-size: 2em;
            }
            
            .modal-content {
                width: 95%;
                margin: 20px;
            }
            
            .modal-body {
                padding: 20px;
            }
            
            .modal-footer {
                flex-direction: column;
            }
            
            .modal-btn {
                width: 100%;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>ğŸ­ å‘½è¿è½¨è¿¹</h1>
            <p>åŸºäºå…«å­—å‘½ç†çš„äººç”Ÿæ¨¡æ‹Ÿæ¸¸æˆ</p>
        </div>
        
        <div class="main-content">
            <div class="sidebar">
                <div class="bazi-info" id="baziInfo">
                    <h3>ğŸ“Š å‘½ç›˜ä¿¡æ¯</h3>
                    <div class="info-item">æ­£åœ¨åŠ è½½...</div>
                </div>

                <div class="life-stages-container">
                    <div id="lifeStages">
                        <!-- äººç”Ÿé˜¶æ®µä¼šåŠ¨æ€ç”Ÿæˆ -->
                    </div>
                </div>

                <div class="ai-config-panel" id="aiConfigPanel">
                    <h4>ğŸ¤– AIé…ç½®</h4>
                    <div class="config-status" id="configStatus">
                        <span style="color: #ff6b6b;">æœªé…ç½®</span>
                    </div>
                    <button class="control-btn" onclick="showAIConfig()" id="configBtn">âš™ï¸ é…ç½®AI</button>
                </div>

                <div class="stats-panel">
                    <h4>ğŸ“ˆ äººç”Ÿæ•°æ®</h4>
                    <div class="stat-item">
                        <span>å¹´é¾„</span>
                        <span id="currentAge">0å²</span>
                    </div>
                    <div class="stat-item">
                        <span>å‘½è¿å€¼</span>
                        <span id="destinyScore">100</span>
                    </div>
                    <div class="stat-item">
                        <span>äº‹ä»¶è®¡æ•°</span>
                        <span id="eventCount">0</span>
                    </div>
                </div>

                <div class="control-buttons">
                    <button class="control-btn" onclick="resetGame()">ğŸ”„ é‡æ–°å¼€å§‹</button>
                    <button class="control-btn" onclick="window.close()">ğŸ  è¿”å›ä¸»é¡µ</button>
                </div>
            </div>
            
            <div class="game-area">
                <!-- æ¸¸æˆè®¾ç½®ç•Œé¢ -->
                <div class="game-settings" id="gameSettings">
                    <div class="settings-title">ğŸ­ å‘½è¿è½¨è¿¹è®¾ç½®</div>
                    <div class="settings-content">
                        <div class="setting-group">
                            <h4>ğŸ“– æ•…äº‹é£æ ¼</h4>
                            <div class="style-options">
                                <label class="style-option">
                                    <input type="radio" name="storyStyle" value="realistic" checked>
                                    <div class="option-card">
                                        <div class="option-icon">ğŸŒ</div>
                                        <div class="option-title">ç°å®å†™å®</div>
                                        <div class="option-desc">åŸºäºçœŸå®å†å²äº‹ä»¶å’Œç¤¾ä¼šèƒŒæ™¯ï¼Œæ¨¡æ‹ŸçœŸå®äººç”Ÿè½¨è¿¹</div>
                                    </div>
                                </label>
                                
                                <label class="style-option">
                                    <input type="radio" name="storyStyle" value="fantasy">
                                    <div class="option-card">
                                        <div class="option-icon">ğŸ”®</div>
                                        <div class="option-title">å¥‡å¹»å†’é™©</div>
                                        <div class="option-desc">èå…¥å¥‡å¹»å…ƒç´ ï¼Œå‘½ç†æ³•åˆ™åŒ–ä¸ºé­”æ³•åŠ›é‡çš„å†’é™©ä¸–ç•Œ</div>
                                    </div>
                                </label>
                                
                                <label class="style-option">
                                    <input type="radio" name="storyStyle" value="historical">
                                    <div class="option-card">
                                        <div class="option-icon">ğŸ›ï¸</div>
                                        <div class="option-title">å¤ä»£ä¼ å¥‡</div>
                                        <div class="option-desc">ç©¿è¶Šå¤ä»£ï¼Œä½“éªŒä¼ ç»Ÿå‘½ç†åœ¨å†å²èƒŒæ™¯ä¸‹çš„äººç”Ÿ</div>
                                    </div>
                                </label>
                                
                                <label class="style-option">
                                    <input type="radio" name="storyStyle" value="modern">
                                    <div class="option-card">
                                        <div class="option-icon">ğŸ™ï¸</div>
                                        <div class="option-title">éƒ½å¸‚ä¼ è¯´</div>
                                        <div class="option-desc">ç°ä»£éƒ½å¸‚èƒŒæ™¯ï¼Œå‘½ç†ä¸ç§‘æŠ€çš„å¥‡å¦™èåˆ</div>
                                    </div>
                                </label>
                            </div>
                        </div>
                        
                        <div class="setting-group" id="realisticOptions">
                            <h4>â° å¼€å§‹æ—¶é—´</h4>
                            <div class="time-options">
                                <label class="time-option">
                                    <input type="radio" name="startTime" value="birth" checked>
                                    <div class="time-card">
                                        <div class="time-icon">ğŸ‘¶</div>
                                        <div class="time-title">ä»å‡ºç”Ÿå¼€å§‹</div>
                                        <div class="time-desc">å®Œæ•´ä½“éªŒäººç”Ÿè½¨è¿¹ï¼Œè§è¯å†å²å˜è¿</div>
                                    </div>
                                </label>
                                
                                <label class="time-option">
                                    <input type="radio" name="startTime" value="current">
                                    <div class="time-card">
                                        <div class="time-icon">ğŸ“…</div>
                                        <div class="time-title">ä»ç°åœ¨å¼€å§‹</div>
                                        <div class="time-desc">åŸºäºå½“å‰å¹´é¾„ï¼Œå±•æœ›æœªæ¥äººç”Ÿ</div>
                                    </div>
                                </label>
                            </div>
                        </div>
                        
                        <div class="setting-actions">
                            <button class="start-game-btn" onclick="startGameWithSettings()">
                                ğŸš€ å¼€å§‹å‘½è¿ä¹‹æ—…
                            </button>
                        </div>
                    </div>
                </div>
                
                <!-- æ¸¸æˆä¸»ç•Œé¢ -->
                <div class="story-section" id="storySection" style="display: none;">
                    <div class="story-title" id="storyTitle">å‘½è¿çš„å¼€å§‹</div>
                    <div class="story-content" id="storyContent">
                        <div class="loading">
                            <div class="loading-spinner"></div>
                            æ­£åœ¨æ ¹æ®æ‚¨çš„å…«å­—æ’ç›˜ç”Ÿæˆä¸“å±å‰§æƒ…...
                        </div>
                    </div>
                </div>
                
                <div class="choices-section" id="choicesSection" style="display: none;">
                    <div class="choices-title">ğŸ¤” æ‚¨ä¼šå¦‚ä½•é€‰æ‹©ï¼Ÿ</div>
                    <div id="choicesList">
                        <!-- é€‰æ‹©æŒ‰é’®ä¼šåŠ¨æ€ç”Ÿæˆ -->
                    </div>
                </div>
            </div>
        </div>
        
        <!-- å³ä¾§æµ®åŠ¨äººç”Ÿè½¨è¿¹é¢æ¿ -->
        <div class="trajectory-panel" id="trajectoryPanel">
            <div class="history-panel" id="historyPanel">
                <h4>ğŸ“œ äººç”Ÿè½¨è¿¹</h4>
                <div id="historyContent">
                    <div class="empty-history">æš‚æ— å†å²è®°å½•</div>
                </div>
            </div>
        </div>
        
        <!-- AIé…ç½®æ¨¡æ€æ¡† -->
        <div id="aiConfigModal" class="modal" style="display: none;">
            <div class="modal-content">
                <div class="modal-header">
                    <h3>ğŸ¤– AIé…ç½®è®¾ç½®</h3>
                    <button class="close-btn" onclick="hideAIConfig()">&times;</button>
                </div>
                <div class="modal-body">
                    <div class="form-group">
                        <label for="modalAiProvider">AIæœåŠ¡å•†</label>
                        <select id="modalAiProvider" onchange="updateModalAIConfig()">
                            <option value="openai">OpenAI (GPT)</option>
                            <option value="claude">Anthropic (Claude)</option>
                            <option value="deepseek">DeepSeek</option>
                            <option value="custom">è‡ªå®šä¹‰æœåŠ¡å•†</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="modalAiModel">AIæ¨¡å‹</label>
                        <select id="modalAiModel">
                            <option value="gpt-3.5-turbo">GPT-3.5 Turbo</option>
                            <option value="gpt-4">GPT-4</option>
                            <option value="gpt-4-turbo">GPT-4 Turbo</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="modalAiApiKey">API Key</label>
                        <input type="password" id="modalAiApiKey" placeholder="è¯·è¾“å…¥æ‚¨çš„API Key">
                    </div>
                    <div class="form-group">
                        <label for="modalAiApiUrl">APIåœ°å€ (å¯é€‰)</label>
                        <input type="text" id="modalAiApiUrl" placeholder="ç•™ç©ºä½¿ç”¨é»˜è®¤åœ°å€">
                    </div>
                    <div class="form-group" id="modalCustomModelGroup" style="display: none;">
                        <label for="modalCustomModel">è‡ªå®šä¹‰æ¨¡å‹å</label>
                        <input type="text" id="modalCustomModel" placeholder="è¾“å…¥è‡ªå®šä¹‰æ¨¡å‹å">
                    </div>
                    <div class="form-group" id="modalCustomHeaderGroup" style="display: none;">
                        <label for="modalCustomHeaders">è‡ªå®šä¹‰Headers (JSONæ ¼å¼)</label>
                        <textarea id="modalCustomHeaders" placeholder='{"X-Custom-Header": "value"}' rows="3"></textarea>
                    </div>
                </div>
                <div class="modal-footer">
                    <button class="modal-btn cancel" onclick="hideAIConfig()">å–æ¶ˆ</button>
                    <button class="modal-btn save" onclick="saveAIConfig()">ä¿å­˜é…ç½®</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        // æ¸¸æˆçŠ¶æ€
        let gameState = {
            baziData: null,
            currentAge: 0,
            currentStage: 'ç«¥å¹´',
            destinyScore: 100,
            eventCount: 0,
            choiceHistory: [],
            storyHistory: [],
            settings: {
                storyStyle: 'realistic',
                startTime: 'birth'
            }
        };
        
        // AIé…ç½®
        let aiConfig = {
            provider: 'openai',
            model: 'gpt-3.5-turbo',
            api_key: '',
            api_url: ''
        };
        
        // äººç”Ÿé˜¶æ®µé…ç½®
        const lifeStages = [
            { name: 'ç«¥å¹´', ageRange: '0-8å²', description: 'å¤©çœŸçƒ‚æ¼«çš„å¯è’™æ—¶æœŸ' },
            { name: 'å°‘å¹´', ageRange: '9-18å²', description: 'æ±‚å­¦æˆé•¿çš„å…³é”®æ—¶æœŸ' },
            { name: 'é’å¹´', ageRange: '19-28å²', description: 'äº‹ä¸šèµ·æ­¥çš„å¥‹æ–—æ—¶æœŸ' },
            { name: 'å£®å¹´', ageRange: '29-38å²', description: 'äº‹ä¸šå®¶åº­çš„åŒçº¿å‘å±•' },
            { name: 'ä¸­å¹´', ageRange: '39-48å²', description: 'äººç”Ÿå·…å³°çš„æ”¶è·æ—¶æœŸ' },
            { name: 'ä¸­è€å¹´', ageRange: '49-58å²', description: 'æ™ºæ…§æ²‰æ·€çš„ä¼ æ‰¿æ—¶æœŸ' },
            { name: 'è€å¹´', ageRange: '59-68å²', description: 'å›é¦–äººç”Ÿçš„æ€»ç»“æ—¶æœŸ' }
        ];
        
        // åˆå§‹åŒ–æ¸¸æˆ
        async function initGame() {
            try {
                console.log('å¼€å§‹åˆå§‹åŒ–æ¸¸æˆ...');

                // ä»localStorageè·å–å…«å­—æ•°æ®
                const baziDataStr = localStorage.getItem('baziData');
                if (!baziDataStr) {
                    alert('æœªæ‰¾åˆ°å…«å­—æ•°æ®ï¼Œè¯·å…ˆå®Œæˆå…«å­—åˆ†æ');
                    window.close();
                    return;
                }

                gameState.baziData = JSON.parse(baziDataStr);
                console.log('å…«å­—æ•°æ®è½½å…¥æˆåŠŸ:', gameState.baziData);

                // æ˜¾ç¤ºå…«å­—ä¿¡æ¯
                displayBaziInfo();
                console.log('å…«å­—ä¿¡æ¯æ˜¾ç¤ºå®Œæˆ');

                // ç”Ÿæˆäººç”Ÿé˜¶æ®µ
                generateLifeStages();
                console.log('äººç”Ÿé˜¶æ®µç”Ÿæˆå®Œæˆ');

                // è·å–AIé…ç½®
                loadAIConfig();
                console.log('AIé…ç½®åŠ è½½å®Œæˆ');

                // è®¾ç½®æ•…äº‹é£æ ¼é€‰æ‹©äº‹ä»¶
                setupStyleSelectionEvents();
                console.log('é£æ ¼é€‰æ‹©äº‹ä»¶è®¾ç½®å®Œæˆ');

                console.log('æ¸¸æˆåˆå§‹åŒ–å®Œæˆ');

            } catch (error) {
                console.error('åˆå§‹åŒ–æ¸¸æˆå¤±è´¥:', error);
                alert('æ¸¸æˆåˆå§‹åŒ–å¤±è´¥ï¼Œè¯·é‡è¯•');
            }
        }
        
        // è®¾ç½®æ•…äº‹é£æ ¼é€‰æ‹©äº‹ä»¶
        function setupStyleSelectionEvents() {
            const storyStyleRadios = document.querySelectorAll('input[name="storyStyle"]');
            const realisticOptions = document.getElementById('realisticOptions');

            storyStyleRadios.forEach(radio => {
                radio.addEventListener('change', function() {
                    if (this.value === 'realistic') {
                        realisticOptions.style.display = 'block';
                    } else {
                        realisticOptions.style.display = 'none';
                        // å…¶ä»–é£æ ¼é»˜è®¤ä»å‡ºç”Ÿå¼€å§‹
                        const birthRadio = document.querySelector('input[name="startTime"][value="birth"]');
                        if (birthRadio) {
                            birthRadio.checked = true;
                        }
                    }
                });
            });

            // åˆå§‹åŒ–æ—¶æ£€æŸ¥å½“å‰é€‰æ‹©çš„é£æ ¼
            const currentStyle = document.querySelector('input[name="storyStyle"]:checked');
            if (currentStyle && currentStyle.value !== 'realistic') {
                realisticOptions.style.display = 'none';
            }
        }
        
        // æ ¹æ®è®¾ç½®å¼€å§‹æ¸¸æˆ
        async function startGameWithSettings() {
            try {
                // è·å–ç”¨æˆ·é€‰æ‹©çš„è®¾ç½®
                const storyStyle = document.querySelector('input[name="storyStyle"]:checked').value;
                let startTime = 'birth'; // é»˜è®¤ä»å‡ºç”Ÿå¼€å§‹

                // åªæœ‰å†™å®é£æ ¼æ‰è€ƒè™‘å¼€å§‹æ—¶é—´é€‰æ‹©
                if (storyStyle === 'realistic') {
                    const startTimeRadio = document.querySelector('input[name="startTime"]:checked');
                    if (startTimeRadio) {
                        startTime = startTimeRadio.value;
                    }
                }

                // ä¿å­˜è®¾ç½®åˆ°æ¸¸æˆçŠ¶æ€
                gameState.settings.storyStyle = storyStyle;
                gameState.settings.startTime = startTime;

                // æ ¹æ®å¼€å§‹æ—¶é—´è®¾ç½®åˆå§‹å¹´é¾„
                if (storyStyle === 'realistic' && startTime === 'current') {
                    // è®¡ç®—å½“å‰å¹´é¾„ï¼ˆç®€åŒ–è®¡ç®—ï¼Œå‡è®¾ç”Ÿæ—¥å·²è¿‡ï¼‰
                    const birthYear = parseInt(gameState.baziData.birth_info.date.split('-')[0]);
                    const currentYear = new Date().getFullYear();
                    gameState.currentAge = currentYear - birthYear;
                } else {
                    gameState.currentAge = 0;
                }

                console.log('æ¸¸æˆè®¾ç½®:', gameState.settings);
                console.log('åˆå§‹å¹´é¾„:', gameState.currentAge);

                // æ›´æ–°æ¸¸æˆç»Ÿè®¡æ˜¾ç¤º
                updateGameStats();
                updateCurrentStage();

                // éšè—è®¾ç½®ç•Œé¢ï¼Œæ˜¾ç¤ºæ¸¸æˆç•Œé¢
                document.getElementById('gameSettings').style.display = 'none';
                document.getElementById('storySection').style.display = 'block';

                // å¼€å§‹ç¬¬ä¸€ä¸ªæ•…äº‹
                await generateNextStory();

            } catch (error) {
                console.error('å¼€å§‹æ¸¸æˆå¤±è´¥:', error);
                alert('å¼€å§‹æ¸¸æˆå¤±è´¥ï¼Œè¯·é‡è¯•');
            }
        }
        
        // æ˜¾ç¤ºå…«å­—ä¿¡æ¯
        function displayBaziInfo() {
            const baziInfo = document.getElementById('baziInfo');
            const birthInfo = gameState.baziData.birth_info;
            
            baziInfo.innerHTML = `
                <h3>ğŸ“Š å‘½ç›˜ä¿¡æ¯</h3>
                <div class="info-item">ğŸ“… ${birthInfo.date}</div>
                <div class="info-item">â° ${birthInfo.time}ç‚¹</div>
                <div class="info-item">ğŸ‘¤ ${birthInfo.gender}</div>
                <div class="info-item">ğŸ² ${birthInfo.shengxiao}</div>
            `;
        }
        
        // ç”Ÿæˆäººç”Ÿé˜¶æ®µ
        function generateLifeStages() {
            const stagesContainer = document.getElementById('lifeStages');
            stagesContainer.innerHTML = lifeStages.map((stage, index) => `
                <div class="life-stage ${index === 0 ? 'current' : ''}" id="stage-${index}" onclick="viewStageHistory(${index})">
                    <h4>${stage.name}</h4>
                    <p>${stage.ageRange}</p>
                    <p>${stage.description}</p>
                    <div class="stage-event-count" id="stageCount-${index}"></div>
                </div>
            `).join('');
            
            // æ›´æ–°é˜¶æ®µäº‹ä»¶è®¡æ•°
            updateStageEventCounts();
        }
        
        // æ›´æ–°é˜¶æ®µäº‹ä»¶è®¡æ•°
        function updateStageEventCounts() {
            lifeStages.forEach((stage, index) => {
                const minAge = index * 10;
                const maxAge = (index + 1) * 10 - 1;
                const eventsInStage = gameState.storyHistory.filter(story => 
                    story.age >= minAge && story.age <= maxAge
                ).length;
                
                const countElement = document.getElementById(`stageCount-${index}`);
                if (countElement) {
                    if (eventsInStage > 0) {
                        countElement.textContent = `${eventsInStage}ä¸ªäº‹ä»¶`;
                        countElement.style.fontSize = '0.8em';
                        countElement.style.opacity = '0.8';
                        countElement.style.marginTop = '5px';
                    } else {
                        countElement.textContent = '';
                    }
                }
            });
        }
        
        // æŸ¥çœ‹é˜¶æ®µå†å²
        function viewStageHistory(stageIndex) {
            const stage = lifeStages[stageIndex];
            const minAge = stageIndex * 10;
            const maxAge = (stageIndex + 1) * 10 - 1;
            
            const stageEvents = gameState.storyHistory.filter(story => 
                story.age >= minAge && story.age <= maxAge
            );
            
            if (stageEvents.length === 0) {
                alert(`${stage.name}é˜¶æ®µæš‚æ— äº‹ä»¶è®°å½•`);
                return;
            }
            
            const modalContent = `
                <div style="max-width: 600px; max-height: 80vh; overflow-y: auto;">
                    <h3>${stage.name}é˜¶æ®µ (${stage.ageRange})</h3>
                    <div style="margin: 15px 0;">
                        ${stageEvents.map(event => `
                            <div style="margin: 15px 0; padding: 15px; background: #f8f9fa; border-radius: 8px; border-left: 4px solid #667eea;">
                                <h4>${event.title}</h4>
                                <p><strong>å¹´é¾„ï¼š</strong>${event.age}å²</p>
                                <div style="margin: 10px 0; line-height: 1.6;">
                                    ${marked.parse(event.story)}
                                </div>
                                ${gameState.choiceHistory[event.eventId] ? `<p><strong>é€‰æ‹©ï¼š</strong>${gameState.choiceHistory[event.eventId]}</p>` : ''}
                            </div>
                        `).join('')}
                    </div>
                    <button onclick="closeStageModal()" style="background: #6c5ce7; color: white; border: none; padding: 10px 20px; border-radius: 5px; cursor: pointer; margin-top: 15px;">å…³é—­</button>
                </div>
            `;
            
            showModal(`${stage.name}é˜¶æ®µå†å²`, modalContent);
        }
        
        // åŠ è½½AIé…ç½®
        function loadAIConfig() {
            // ä¼˜å…ˆä»localStorageè·å–å‘½è¿è½¨è¿¹ä¸“ç”¨çš„AIé…ç½®
            let savedConfig = localStorage.getItem('destinyAiConfig');
            if (savedConfig) {
                aiConfig = JSON.parse(savedConfig);
                updateConfigStatus();
                return;
            }
            
            // å¦‚æœæ²¡æœ‰ä¸“ç”¨é…ç½®ï¼Œå°è¯•ä»é€šç”¨AIé…ç½®è·å–
            savedConfig = localStorage.getItem('aiConfig');
            if (savedConfig) {
                aiConfig = JSON.parse(savedConfig);
                updateConfigStatus();
                return;
            }
            
            // éƒ½æ²¡æœ‰é…ç½®ï¼Œæ˜¾ç¤ºæœªé…ç½®çŠ¶æ€
            updateConfigStatus();
        }
        
        // æ›´æ–°é…ç½®çŠ¶æ€æ˜¾ç¤º
        function updateConfigStatus() {
            const configStatus = document.getElementById('configStatus');
            const configBtn = document.getElementById('configBtn');
            
            if (aiConfig && aiConfig.api_key) {
                configStatus.innerHTML = `<span style="color: #00b894;">${aiConfig.provider} - å·²é…ç½®</span>`;
                configBtn.textContent = 'âš™ï¸ ä¿®æ”¹é…ç½®';
            } else {
                configStatus.innerHTML = '<span style="color: #ff6b6b;">æœªé…ç½®</span>';
                configBtn.textContent = 'âš™ï¸ é…ç½®AI';
            }
        }
        
        // æ˜¾ç¤ºAIé…ç½®ç•Œé¢
        function showAIConfig() {
            const modal = document.getElementById('aiConfigModal');
            
            // å¦‚æœå·²æœ‰é…ç½®ï¼Œå¡«å…¥å½“å‰å€¼
            if (aiConfig && aiConfig.api_key) {
                document.getElementById('modalAiProvider').value = aiConfig.provider || 'openai';
                document.getElementById('modalAiModel').value = aiConfig.model || 'gpt-3.5-turbo';
                document.getElementById('modalAiApiKey').value = aiConfig.api_key || '';
                document.getElementById('modalAiApiUrl').value = aiConfig.api_url || '';
                document.getElementById('modalCustomModel').value = '';
                document.getElementById('modalCustomHeaders').value = aiConfig.custom_headers ? JSON.stringify(aiConfig.custom_headers, null, 2) : '';
            }
            
            updateModalAIConfig();
            modal.style.display = 'flex';
        }
        
        // éšè—AIé…ç½®ç•Œé¢
        function hideAIConfig() {
            document.getElementById('aiConfigModal').style.display = 'none';
        }
        
        // æ›´æ–°æ¨¡æ€æ¡†ä¸­çš„AIé…ç½®é€‰é¡¹
        function updateModalAIConfig() {
            const provider = document.getElementById('modalAiProvider').value;
            const modelSelect = document.getElementById('modalAiModel');
            const customModelGroup = document.getElementById('modalCustomModelGroup');
            const customHeaderGroup = document.getElementById('modalCustomHeaderGroup');
            const apiUrlInput = document.getElementById('modalAiApiUrl');
            
            // æ›´æ–°æ¨¡å‹é€‰é¡¹
            if (provider === 'openai') {
                modelSelect.innerHTML = `
                    <option value="gpt-3.5-turbo">GPT-3.5 Turbo</option>
                    <option value="gpt-4">GPT-4</option>
                    <option value="gpt-4-turbo">GPT-4 Turbo</option>
                    <option value="gpt-4o">GPT-4o</option>
                `;
                apiUrlInput.placeholder = "ç•™ç©ºä½¿ç”¨é»˜è®¤: https://api.openai.com/v1/chat/completions";
            } else if (provider === 'claude') {
                modelSelect.innerHTML = `
                    <option value="claude-3-sonnet-20240229">Claude 3 Sonnet</option>
                    <option value="claude-3-opus-20240229">Claude 3 Opus</option>
                    <option value="claude-3-haiku-20240307">Claude 3 Haiku</option>
                `;
                apiUrlInput.placeholder = "ç•™ç©ºä½¿ç”¨é»˜è®¤: https://api.anthropic.com/v1/messages";
            } else if (provider === 'deepseek') {
                modelSelect.innerHTML = `
                    <option value="deepseek-chat">DeepSeek Chat</option>
                    <option value="deepseek-coder">DeepSeek Coder</option>
                `;
                apiUrlInput.placeholder = "ç•™ç©ºä½¿ç”¨é»˜è®¤: https://api.deepseek.com/v1/chat/completions";
            } else if (provider === 'custom') {
                modelSelect.innerHTML = `
                    <option value="gpt-3.5-turbo">GPT-3.5 Turbo</option>
                    <option value="gpt-4">GPT-4</option>
                    <option value="custom-model">è‡ªå®šä¹‰æ¨¡å‹</option>
                `;
                apiUrlInput.placeholder = "å¿…å¡«: è¾“å…¥å®Œæ•´çš„APIåœ°å€";
            }
            
            // æ˜¾ç¤º/éšè—è‡ªå®šä¹‰é€‰é¡¹
            if (provider === 'custom') {
                customModelGroup.style.display = 'block';
                customHeaderGroup.style.display = 'block';
            } else {
                customModelGroup.style.display = 'none';
                customHeaderGroup.style.display = 'none';
            }
        }
        
        // ä¿å­˜AIé…ç½®
        function saveAIConfig() {
            const provider = document.getElementById('modalAiProvider').value;
            const model = document.getElementById('modalAiModel').value;
            const apiKey = document.getElementById('modalAiApiKey').value;
            const apiUrl = document.getElementById('modalAiApiUrl').value;
            const customModel = document.getElementById('modalCustomModel').value;
            const customHeaders = document.getElementById('modalCustomHeaders').value;
            
            if (!apiKey.trim()) {
                alert('è¯·è¾“å…¥API Key');
                return;
            }
            
            if (provider === 'custom' && !apiUrl.trim()) {
                alert('è‡ªå®šä¹‰æœåŠ¡å•†å¿…é¡»å¡«å†™APIåœ°å€');
                return;
            }
            
            // æ„å»ºé…ç½®å¯¹è±¡
            let finalModel = model;
            aiConfig = {
                provider: provider,
                model: finalModel,
                api_key: apiKey.trim()
            };
            
            if (provider === 'custom') {
                if (model === 'custom-model' && customModel.trim()) {
                    finalModel = customModel.trim();
                    aiConfig.model = finalModel;
                }
                aiConfig.api_url = apiUrl.trim();
                
                if (customHeaders.trim()) {
                    try {
                        aiConfig.custom_headers = JSON.parse(customHeaders.trim());
                    } catch (e) {
                        alert('è‡ªå®šä¹‰Headersæ ¼å¼é”™è¯¯ï¼Œè¯·æ£€æŸ¥JSONæ ¼å¼');
                        return;
                    }
                }
            } else if (apiUrl.trim()) {
                aiConfig.api_url = apiUrl.trim();
            }
            
            // ä¿å­˜é…ç½®
            localStorage.setItem('destinyAiConfig', JSON.stringify(aiConfig));
            
            // æ›´æ–°çŠ¶æ€æ˜¾ç¤º
            updateConfigStatus();
            
            // éšè—æ¨¡æ€æ¡†
            hideAIConfig();
            
            alert('AIé…ç½®ä¿å­˜æˆåŠŸï¼');
        }
        
        // ç”Ÿæˆä¸‹ä¸€ä¸ªæ•…äº‹
        async function generateNextStory() {
            try {
                // æ£€æŸ¥AIé…ç½®
                if (!aiConfig || !aiConfig.api_key) {
                    const storyContent = document.getElementById('storyContent');
                    storyContent.innerHTML = `
                        <div style="text-align: center; padding: 40px; color: #e74c3c;">
                            <h3>âš ï¸ éœ€è¦é…ç½®AI</h3>
                            <p>è¯·å…ˆé…ç½®AI APIä¿¡æ¯æ‰èƒ½å¼€å§‹æ¸¸æˆ</p>
                            <button onclick="showAIConfig()" style="background: linear-gradient(45deg, #FF6B6B, #4ECDC4); color: white; border: none; padding: 15px 30px; border-radius: 8px; cursor: pointer; font-size: 1.1em; margin-top: 15px;">
                                ğŸ¤– ç«‹å³é…ç½®
                            </button>
                        </div>
                    `;
                    return;
                }
                
                // æ˜¾ç¤ºåŠ è½½çŠ¶æ€
                const storyContent = document.getElementById('storyContent');
                const choicesSection = document.getElementById('choicesSection');
                
                storyContent.innerHTML = `
                    <div class="loading">
                        <div class="loading-spinner"></div>
                        AIæ­£åœ¨æ ¹æ®æ‚¨çš„å‘½ç†ç‰¹å¾ç”Ÿæˆå‰§æƒ…...
                    </div>
                `;
                choicesSection.style.display = 'none';
                
                // æ„å»ºAIæç¤ºè¯
                const prompt = buildStoryPrompt();
                
                // ä½¿ç”¨æµå¼API
                const response = await fetch('/api/destiny-story-stream', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        prompt: prompt,
                        ai_config: aiConfig,
                        game_state: gameState
                    })
                });
                
                if (!response.ok) {
                    throw new Error(`HTTPé”™è¯¯: ${response.status}`);
                }
                
                // å¤„ç†æµå¼å“åº” - ç®€åŒ–ç‰ˆæœ¬ï¼šç­‰å¾…å®Œæ•´è¾“å‡ºåå†æ¸²æŸ“
                const reader = response.body.getReader();
                const decoder = new TextDecoder();
                let fullContent = '';
                let storyData = null;

                // æ˜¾ç¤ºåŠ è½½çŠ¶æ€
                storyContent.innerHTML = `
                    <div class="loading">
                        <div class="loading-spinner"></div>
                        AIæ­£åœ¨æ ¹æ®æ‚¨çš„å‘½ç†ç‰¹å¾ç”Ÿæˆå‰§æƒ…...
                    </div>
                `;

                while (true) {
                    const { done, value } = await reader.read();

                    if (done) {
                        break;
                    }

                    const chunk = decoder.decode(value, { stream: true });
                    const lines = chunk.split('\n');

                    for (const line of lines) {
                        if (line.startsWith('data: ')) {
                            const data = line.slice(6);
                            if (data.trim() === '') continue;

                            try {
                                const parsed = JSON.parse(data);

                                if (parsed.error) {
                                    throw new Error(parsed.error);
                                }

                                if (parsed.content) {
                                    fullContent += parsed.content;
                                }

                                if (parsed.done) {
                                    console.log('AIè¾“å‡ºå®Œæˆï¼Œå¼€å§‹è§£æ...');
                                    break;
                                }
                            } catch (e) {
                                console.error('è§£æé”™è¯¯:', e);
                                continue;
                            }
                        }
                    }
                }

                // AIè¾“å‡ºå®Œæˆï¼Œè§£æJSONæ•°æ®
                console.log('å®Œæ•´å†…å®¹:', fullContent);

                const jsonMatch = fullContent.match(/```json\s*({[\s\S]*?})\s*```/);
                if (jsonMatch) {
                    try {
                        storyData = JSON.parse(jsonMatch[1]);
                        console.log('è§£æåˆ°æ•…äº‹æ•°æ®:', storyData);

                        // æ¸²æŸ“æ ‡é¢˜å’Œæ•…äº‹
                        storyContent.innerHTML = `
                            <div style="padding: 20px;">
                                <h3 style="color: #667eea; font-size: 1.5em; margin-bottom: 20px;">${storyData.title}</h3>
                                <div style="line-height: 1.8; white-space: pre-wrap;">${storyData.story}</div>
                            </div>
                        `;

                        // å»¶è¿Ÿæ˜¾ç¤ºé€‰æ‹©æŒ‰é’®
                        setTimeout(() => {
                            displayChoices(storyData);
                        }, 1000);

                    } catch (e) {
                        console.error('JSONè§£æå¤±è´¥:', e);
                        throw new Error('æ•…äº‹æ•°æ®è§£æå¤±è´¥');
                    }
                } else {
                    console.error('æœªæ‰¾åˆ°JSONæ•°æ®');
                    throw new Error('æœªæ‰¾åˆ°æœ‰æ•ˆçš„æ•…äº‹æ•°æ®');
                }
                
                if (!storyData) {
                    throw new Error('æœªèƒ½è·å–å®Œæ•´çš„æ•…äº‹æ•°æ®');
                }
                
            } catch (error) {
                console.error('ç”Ÿæˆæ•…äº‹å¤±è´¥:', error);
                document.getElementById('storyContent').innerHTML = `
                    <div style="color: #ff6b6b; text-align: center; padding: 20px;">
                        âŒ æ•…äº‹ç”Ÿæˆå¤±è´¥: ${error.message}
                        <br><br>
                        <button onclick="generateNextStory()" style="background: #6c5ce7; color: white; border: none; padding: 10px 20px; border-radius: 5px; cursor: pointer;">
                            ğŸ”„ é‡è¯•
                        </button>
                        <button onclick="showAIConfig()" style="background: #e17055; color: white; border: none; padding: 10px 20px; border-radius: 5px; cursor: pointer; margin-left: 10px;">
                            âš™ï¸ æ£€æŸ¥é…ç½®
                        </button>
                    </div>
                `;
            }
        }
        
        // æ˜¾ç¤ºé€‰æ‹©æŒ‰é’®çš„å‡½æ•°
        function displayChoices(storyData) {
            console.log('æ˜¾ç¤ºé€‰æ‹©æŒ‰é’®ï¼Œæ•…äº‹æ•°æ®:', storyData);

            const choicesSection = document.getElementById('choicesSection');
            const choicesList = document.getElementById('choicesList');

            if (!storyData || !storyData.choices || storyData.choices.length === 0) {
                console.error('æ²¡æœ‰å¯ç”¨çš„é€‰æ‹©é¡¹');
                return;
            }

            // éšæœºåŒ–é€‰æ‹©æ•°é‡å’Œå‘½è¿å€¼
            let choices = [...storyData.choices];

            // éšæœºåŒ–é€‰æ‹©æ•°é‡ï¼ˆ2-4ä¸ªï¼‰
            const choiceCount = Math.min(choices.length, Math.floor(Math.random() * 3) + 2);

            // éšæœºæ‰“ä¹±é€‰æ‹©é¡ºåº
            for (let i = choices.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [choices[i], choices[j]] = [choices[j], choices[i]];
            }

            // åªå–å‰ choiceCount ä¸ªé€‰æ‹©
            choices = choices.slice(0, choiceCount);

            // éšæœºåŒ–å‘½è¿å€¼ï¼ˆé¿å…å›ºå®šå€¼ï¼‰
            choices.forEach((choice, index) => {
                const baseImpact = choice.destiny_impact || 0;
                const randomVariation = Math.floor(Math.random() * 8) - 4; // -4 åˆ° +4
                choice.destiny_impact = Math.max(-15, Math.min(15, baseImpact + randomVariation));
                choice.choiceIndex = index; // ä¿å­˜åŸå§‹ç´¢å¼•
            });

            // æ£€æŸ¥æ˜¯å¦åº”è¯¥ç»“æŸæ¸¸æˆ
            const shouldEndGame = gameState.currentAge >= 80 || gameState.destinyScore <= 0;

            if (shouldEndGame) {
                // æ˜¾ç¤ºæ¸¸æˆç»“æŸæŒ‰é’®
                choicesList.innerHTML = `
                    <button class="choice-button" onclick="endGame()" style="background: linear-gradient(45deg, #ff6b6b, #ee5a24);">
                        <span class="choice-number">âœ¨</span>
                        æŸ¥çœ‹äººç”Ÿæ€»ç»“å’Œç›–æ£ºå®šè®º
                    </button>
                `;
            } else {
                // æ˜¾ç¤ºæ­£å¸¸é€‰æ‹©ï¼ˆéšè—å‘½è¿å€¼ï¼‰
                choicesList.innerHTML = choices.map((choice, index) => {
                    const choiceId = `choice_${Date.now()}_${index}`;
                    const safeText = choice.text.replace(/'/g, "\\'").replace(/"/g, '\\"');
                    const safeTitle = storyData.title.replace(/'/g, "\\'").replace(/"/g, '\\"');

                    return `
                        <button class="choice-button" id="${choiceId}" onclick="makeChoice(${choice.choiceIndex}, '${safeText}', ${choice.destiny_impact}, '${safeTitle}', '${choiceId}')">
                            <span class="choice-number">${index + 1}</span>
                            ${choice.text}
                            <br>
                            <small style="opacity: 0.8; margin-left: 35px;">é¢„æœŸå½±å“: ${choice.consequence || 'æœªçŸ¥'}</small>
                        </button>
                    `;
                }).join('');
            }

            choicesSection.style.display = 'block';
            console.log('é€‰æ‹©æŒ‰é’®å·²æ˜¾ç¤º');

            // ä¿å­˜å½“å‰æ•…äº‹
            if (!gameState.storyHistory.find(s => s.title === storyData.title && s.age === gameState.currentAge)) {
                gameState.storyHistory.push({
                    ...storyData,
                    age: gameState.currentAge,
                    eventId: gameState.eventCount,
                    timestamp: new Date().toISOString()
                });
            }
        }
        
        // æ„å»ºæ•…äº‹æç¤ºè¯
        function buildStoryPrompt() {
            const birthInfo = gameState.baziData.birth_info;
            const baziAnalysis = gameState.baziData.bazi_analysis;
            const shengxiaoAnalysis = gameState.baziData.shengxiao_analysis;
            const currentStage = lifeStages[Math.floor(gameState.currentAge / 10)] || lifeStages[0];
            const storyStyle = gameState.settings.storyStyle;
            const startTime = gameState.settings.startTime;
            
            // æ ¹æ®æ•…äº‹é£æ ¼ç”Ÿæˆä¸åŒçš„èƒŒæ™¯è®¾å®š
            let styleContext = '';
            let styleRequirements = '';
            
            switch (storyStyle) {
                case 'realistic':
                    const birthYear = parseInt(birthInfo.date.split('-')[0]);
                    let currentYear;

                    if (startTime === 'current') {
                        // ä»ç°åœ¨å¼€å§‹ï¼šå½“å‰å¹´ä»½ + æ¸¸æˆä¸­ç»è¿‡çš„å¹´é¾„
                        currentYear = new Date().getFullYear() + (gameState.currentAge - (new Date().getFullYear() - birthYear));
                    } else {
                        // ä»å‡ºç”Ÿå¼€å§‹ï¼šå‡ºç”Ÿå¹´ä»½ + å½“å‰æ¸¸æˆå¹´é¾„
                        currentYear = birthYear + gameState.currentAge;
                    }

                    styleContext = `
## æ•…äº‹èƒŒæ™¯è®¾å®šï¼š
- æ•…äº‹é£æ ¼ï¼šç°å®å†™å®
- æ—¶ä»£èƒŒæ™¯ï¼š${currentYear}å¹´
- å†å²ç¯å¢ƒï¼šè¯·ç»“åˆ${currentYear}å¹´å‰åçš„çœŸå®å†å²äº‹ä»¶å’Œç¤¾ä¼šèƒŒæ™¯
- å¼€å§‹æ—¶é—´ï¼š${startTime === 'birth' ? 'ä»å‡ºç”Ÿå¼€å§‹' : 'ä»ç°åœ¨å¼€å§‹'}
- å½“å‰å®é™…å¹´é¾„ï¼š${gameState.currentAge}å²`;

                    styleRequirements = `
- æ•…äº‹å¿…é¡»åŸºäºçœŸå®çš„å†å²äº‹ä»¶å’Œç¤¾ä¼šèƒŒæ™¯
- èå…¥${currentYear}å¹´ä»£çš„æ—¶ä»£ç‰¹è‰²ï¼ˆç§‘æŠ€ã€æ–‡åŒ–ã€æ”¿æ²»ç¯å¢ƒç­‰ï¼‰
- äº‹ä»¶è¦ç¬¦åˆå½“æ—¶çš„ç¤¾ä¼šç°å®å’Œå†å²å¯èƒ½æ€§
- å¦‚æœæ¶‰åŠé‡å¤§å†å²äº‹ä»¶ï¼Œè¦ä¿æŒå†å²å‡†ç¡®æ€§
- æ•…äº‹ä¸å¿…è¿‡äºç„ä¹ï¼Œéšæœºäº‹ä»¶ä¸åº”å¤ªç»Ÿä¸€ç±»å‹ï¼Œå¤§äº‹ä»¶ä¹Ÿæœ‰å¯èƒ½æ˜¯é»‘å¤©é¹…äº‹ä»¶ï¼Œæ¯”å¦‚ç–«æƒ…ã€åœ°éœ‡ã€ç»æµå±æœºã€æˆ˜äº‰ã€ç§‘æŠ€å˜é©ç­‰
- é‡è¦ï¼šæ•…äº‹ä¸­æåˆ°çš„å¹´é¾„å¿…é¡»ä¸å½“å‰æ¸¸æˆå¹´é¾„(${gameState.currentAge}å²)ä¿æŒä¸€è‡´`;
                    break;
                    
                case 'fantasy':
                    styleContext = `
## æ•…äº‹èƒŒæ™¯è®¾å®šï¼š
- æ•…äº‹é£æ ¼ï¼šå¥‡å¹»å†’é™©
- ä¸–ç•Œè§‚ï¼šå‘½ç†æ³•åˆ™åŒ–ä¸ºé­”æ³•åŠ›é‡çš„å¥‡å¹»ä¸–ç•Œ
- å…«å­—å¯¹åº”ï¼šäº”è¡Œæˆä¸ºé­”æ³•å…ƒç´ ï¼Œåç¥åŒ–ä¸ºå¤©èµ‹æŠ€èƒ½
- ç¥ç…ç³»ç»Ÿï¼šå¤ä»£ç¥ç…æˆä¸ºç¥ç§˜åŠ›é‡çš„æºæ³‰`;
                    
                    styleRequirements = `
- å°†å…«å­—å‘½ç†æ¦‚å¿µèå…¥å¥‡å¹»å…ƒç´ ï¼ˆå¦‚äº”è¡Œé­”æ³•ã€å‘½æ ¼å¤©èµ‹ç­‰ï¼‰
- åˆ›é€ å……æ»¡æƒ³è±¡åŠ›çš„å¥‡å¹»åœºæ™¯å’Œç”Ÿç‰©
- ä¿æŒå‘½ç†å­¦é€»è¾‘çš„åŒæ—¶ï¼Œå¢åŠ é­”æ³•å†’é™©å…ƒç´ 
- æ•…äº‹è¦æœ‰å¥‡å¹»è‰²å½©ä½†ä»ä½“ç°äººç”Ÿé€‰æ‹©çš„é‡è¦æ€§`;
                    break;
                    
                case 'historical':
                    styleContext = `
## æ•…äº‹èƒŒæ™¯è®¾å®šï¼š
- æ•…äº‹é£æ ¼ï¼šå¤ä»£ä¼ å¥‡
- æ—¶ä»£èƒŒæ™¯ï¼šä¸­å›½å¤ä»£ä¼ ç»Ÿç¤¾ä¼š
- æ–‡åŒ–ç¯å¢ƒï¼šä¼ ç»Ÿå‘½ç†å­¦ç››è¡Œçš„æ—¶ä»£
- ç¤¾ä¼šç»“æ„ï¼šå¤ä»£çš„å®¶æ—ã€å®˜åœºã€æ±Ÿæ¹–ä½“ç³»`;
                    
                    styleRequirements = `
- æ•…äº‹å‘ç”Ÿåœ¨ä¸­å›½å¤ä»£ï¼Œä½“ç°ä¼ ç»Ÿæ–‡åŒ–å’Œç¤¾ä¼šåˆ¶åº¦
- èå…¥å¤ä»£çš„ç§‘ä¸¾ã€å®¶æ—ã€å¸ˆæ‰¿ç­‰ç¤¾ä¼šå…ƒç´ 
- ä½¿ç”¨ç¬¦åˆå¤ä»£èƒŒæ™¯çš„è¯­è¨€é£æ ¼å’Œæƒ…èŠ‚è®¾å®š
- å¼ºè°ƒä¼ ç»Ÿå‘½ç†å­¦åœ¨å¤ä»£ç¤¾ä¼šä¸­çš„ä½œç”¨å’Œå½±å“`;
                    break;
                    
                case 'modern':
                    styleContext = `
## æ•…äº‹èƒŒæ™¯è®¾å®šï¼š
- æ•…äº‹é£æ ¼ï¼šéƒ½å¸‚ä¼ è¯´
- æ—¶ä»£èƒŒæ™¯ï¼šç°ä»£éƒ½å¸‚
- ç§‘æŠ€ç¯å¢ƒï¼šå‘½ç†ä¸ç°ä»£ç§‘æŠ€çš„ç¥ç§˜èåˆ
- ç¤¾ä¼šèƒŒæ™¯ï¼šç°ä»£éƒ½å¸‚ä¸­éšè—çš„å‘½ç†ç§˜å¯†`;
                    
                    styleRequirements = `
- æ•…äº‹è®¾å®šåœ¨ç°ä»£éƒ½å¸‚ç¯å¢ƒä¸­
- å°†ä¼ ç»Ÿå‘½ç†å­¦ä¸ç°ä»£ç§‘æŠ€å·§å¦™ç»“åˆ
- åˆ›é€ éƒ½å¸‚ä¼ è¯´èˆ¬çš„ç¥ç§˜æ°›å›´
- ä½“ç°ç°ä»£äººç”Ÿæ´»ä¸­çš„å‘½ç†å…ƒç´ å’Œé€‰æ‹©`;
                    break;
            }
            
            return `ä½ æ˜¯ä¸€ä½ç²¾é€šå‘½ç†å­¦çš„æ¸¸æˆå‰§æƒ…è®¾è®¡å¸ˆï¼Œè¯·åŸºäºä»¥ä¸‹å…«å­—ä¿¡æ¯ä¸ºç”¨æˆ·åˆ›å»ºä¸€ä¸ªå‘½è¿è½¨è¿¹æ¸¸æˆçš„æƒ…èŠ‚ã€‚

## ç”¨æˆ·å…«å­—ä¿¡æ¯ï¼š
- å‡ºç”Ÿæ—¥æœŸï¼š${birthInfo.date} (${birthInfo.calendar_type})
- å‡ºç”Ÿæ—¶è¾°ï¼š${birthInfo.time}ç‚¹
- æ€§åˆ«ï¼š${birthInfo.gender}
- ç”Ÿè‚–ï¼š${birthInfo.shengxiao}

## å…«å­—åˆ†æï¼š
${baziAnalysis}

## ç”Ÿè‚–åˆ†æï¼š
å¹´æ”¯ï¼š${shengxiaoAnalysis.year_zhi}
ç›¸åˆç”Ÿè‚–ï¼š${JSON.stringify(shengxiaoAnalysis.compatible)}
ç›¸å†²ç”Ÿè‚–ï¼š${JSON.stringify(shengxiaoAnalysis.incompatible)}

${styleContext}

## å½“å‰æ¸¸æˆçŠ¶æ€ï¼š
- å½“å‰å¹´é¾„ï¼š${gameState.currentAge}å²
- äººç”Ÿé˜¶æ®µï¼š${currentStage.name} (${currentStage.description})
- å‘½è¿å€¼ï¼š${gameState.destinyScore}
- å·²å‘ç”Ÿäº‹ä»¶ï¼š${gameState.eventCount}ä¸ª

## å†å²é€‰æ‹©è®°å½•ï¼š
${gameState.choiceHistory.length > 0 ? gameState.choiceHistory.map((choice, index) => `${index + 1}. ${choice}`).join('\n') : 'æš‚æ— å†å²é€‰æ‹©'}

## ä»»åŠ¡è¦æ±‚ï¼š
è¯·åˆ›å»ºä¸€ä¸ªç¬¦åˆç”¨æˆ·å‘½ç†ç‰¹å¾çš„äººç”Ÿæƒ…èŠ‚ï¼ŒåŒ…å«ï¼š

1. **æƒ…èŠ‚æè¿°**ï¼šæ ¹æ®ç”¨æˆ·çš„å…«å­—ç‰¹ç‚¹å’Œå½“å‰å¹´é¾„é˜¶æ®µï¼Œæè¿°ä¸€ä¸ªå…·ä½“çš„äººç”Ÿäº‹ä»¶æˆ–æƒ…å†µ
2. **3-4ä¸ªé€‰æ‹©é¡¹**ï¼šæä¾›3-4ä¸ªä¸åŒçš„åº”å¯¹æ–¹å¼ï¼Œä½“ç°ä¸åŒçš„äººç”Ÿæ€åº¦å’Œä»·å€¼è§‚

## é‡è¦æ³¨æ„äº‹é¡¹ï¼š
- æ•…äº‹ä¸­æåˆ°çš„å¹´é¾„å¿…é¡»ä¸¥æ ¼ä¸å½“å‰æ¸¸æˆå¹´é¾„(${gameState.currentAge}å²)ä¿æŒä¸€è‡´
- ä¸è¦åœ¨æ•…äº‹ä¸­å‡ºç°ä¸å½“å‰å¹´é¾„ä¸ç¬¦çš„æè¿°
- å¦‚æœæ˜¯0å²ï¼Œåº”è¯¥æè¿°å©´å„¿æ—¶æœŸçš„äº‹ä»¶
- å¦‚æœæ˜¯æˆå¹´äººï¼Œä¸è¦æè¿°ç«¥å¹´åœºæ™¯

## æ•…äº‹é£æ ¼è¦æ±‚ï¼š
${styleRequirements}

## è¾“å‡ºæ ¼å¼ï¼š
è¯·ä¸¥æ ¼æŒ‰ç…§ä»¥ä¸‹JSONæ ¼å¼è¾“å‡ºï¼š

\`\`\`json
{
  "title": "æƒ…èŠ‚æ ‡é¢˜",
  "story": "è¯¦ç»†çš„æ•…äº‹æè¿°ï¼Œè¦ç”ŸåŠ¨æœ‰è¶£ï¼Œç¬¦åˆå‘½ç†ç‰¹å¾å’Œæ•…äº‹é£æ ¼",
  "choices": [
    {
      "text": "é€‰æ‹©1çš„æè¿°",
      "consequence": "è¿™ä¸ªé€‰æ‹©å¯èƒ½å¸¦æ¥çš„ç»“æœ",
      "destiny_impact": 5
    },
    {
      "text": "é€‰æ‹©2çš„æè¿°", 
      "consequence": "è¿™ä¸ªé€‰æ‹©å¯èƒ½å¸¦æ¥çš„ç»“æœ",
      "destiny_impact": -3
    },
    {
      "text": "é€‰æ‹©3çš„æè¿°",
      "consequence": "è¿™ä¸ªé€‰æ‹©å¯èƒ½å¸¦æ¥çš„ç»“æœ", 
      "destiny_impact": 0
    }
  ]
}
\`\`\`

è¦æ±‚ï¼š
- æ•…äº‹è¦ç¬¦åˆç”¨æˆ·çš„å…«å­—å‘½ç†ç‰¹å¾å’Œé€‰æ‹©çš„æ•…äº‹é£æ ¼
- é€‰æ‹©è¦æœ‰æ˜ç¡®çš„åæœé¢„ç¤º
- destiny_impactèŒƒå›´åœ¨-10åˆ°+10ä¹‹é—´ï¼Œä½†ä¸åº”å›ºå®šé¡ºåºå’Œæ•°å€¼ï¼Œè¦éšæœºåˆ†å¸ƒ
- è¯­è¨€è¦ç”ŸåŠ¨æœ‰è¶£ï¼Œé€‚åˆæ¸¸æˆä½“éªŒ
- ä½“ç°å‘½ç†å­¦ä¸­çš„å› æœå…³ç³»
- **å…³é”®è¦æ±‚ï¼šæ•…äº‹ä¸­çš„å¹´é¾„æè¿°å¿…é¡»ä¸å½“å‰æ¸¸æˆå¹´é¾„(${gameState.currentAge}å²)å®Œå…¨ä¸€è‡´ï¼Œä¸å¾—å‡ºç°å¹´é¾„é”™è¯¯**`;
        }
        
        // åšå‡ºé€‰æ‹©
        async function makeChoice(choiceIndex, choiceText, destinyImpact, storyTitle, choiceId) {
            try {
                console.log('ç”¨æˆ·é€‰æ‹©:', { choiceIndex, choiceText, destinyImpact, storyTitle, choiceId });

                // ç«‹å³ç¦ç”¨æ‰€æœ‰é€‰æ‹©æŒ‰é’®ï¼Œé¿å…é‡å¤ç‚¹å‡»
                const choiceButtons = document.querySelectorAll('.choice-button');
                choiceButtons.forEach(btn => {
                    btn.disabled = true;
                    btn.style.opacity = '0.6';
                    btn.style.cursor = 'not-allowed';
                });

                // é«˜äº®é€‰ä¸­çš„æŒ‰é’®
                if (choiceId) {
                    const selectedButton = document.getElementById(choiceId);
                    if (selectedButton) {
                        selectedButton.style.background = 'linear-gradient(45deg, #00b894, #00a085)';
                        selectedButton.style.transform = 'scale(0.98)';
                    }
                }

                // è®°å½•é€‰æ‹©
                gameState.choiceHistory.push(choiceText);
                gameState.destinyScore += destinyImpact;
                gameState.eventCount++;
                gameState.currentAge += Math.floor(Math.random() * 3) + 1; // éšæœºå¢åŠ 1-3å²

                // æ›´æ–°æ˜¾ç¤º
                updateGameStats();
                updateCurrentStage();
                updateHistoryDisplay();
                updateStageEventCounts();

                // éšè—é€‰æ‹©åŒºåŸŸ
                document.getElementById('choicesSection').style.display = 'none';

                // æ˜¾ç¤ºåŠ è½½çŠ¶æ€
                const storyContent = document.getElementById('storyContent');
                storyContent.innerHTML = `
                    <div class="loading">
                        <div class="loading-spinner"></div>
                        æ­£åœ¨æ ¹æ®æ‚¨çš„é€‰æ‹©ç”Ÿæˆä¸‹ä¸€ä¸ªæ•…äº‹...
                    </div>
                `;

                // å»¶è¿Ÿåç”Ÿæˆä¸‹ä¸€ä¸ªæ•…äº‹
                setTimeout(async () => {
                    await generateNextStory();
                }, 1500);

            } catch (error) {
                console.error('å¤„ç†é€‰æ‹©å¤±è´¥:', error);

                // é‡æ–°å¯ç”¨æŒ‰é’®
                const choiceButtons = document.querySelectorAll('.choice-button');
                choiceButtons.forEach(btn => {
                    btn.disabled = false;
                    btn.style.opacity = '1';
                    btn.style.cursor = 'pointer';
                });

                alert('å¤„ç†é€‰æ‹©æ—¶å‘ç”Ÿé”™è¯¯ï¼Œè¯·é‡è¯•');
            }
        }
        
        // æ›´æ–°æ¸¸æˆç»Ÿè®¡
        function updateGameStats() {
            document.getElementById('currentAge').textContent = `${gameState.currentAge}å²`;
            document.getElementById('destinyScore').textContent = gameState.destinyScore;
            document.getElementById('eventCount').textContent = gameState.eventCount;
        }
        
        // æ›´æ–°å½“å‰é˜¶æ®µ
        function updateCurrentStage() {
            const stageIndex = Math.min(Math.floor(gameState.currentAge / 10), lifeStages.length - 1);
            
            // æ›´æ–°å½“å‰é˜¶æ®µæ ·å¼
            document.querySelectorAll('.life-stage').forEach((stage, index) => {
                stage.classList.toggle('current', index === stageIndex);
            });
            
            gameState.currentStage = lifeStages[stageIndex].name;
        }
        
        // æ›´æ–°å†å²è®°å½•æ˜¾ç¤º
        function updateHistoryDisplay() {
            const historyContent = document.getElementById('historyContent');
            
            if (gameState.storyHistory.length === 0) {
                historyContent.innerHTML = '<div class="empty-history">æš‚æ— å†å²è®°å½•</div>';
                return;
            }
            
            const historyHTML = gameState.storyHistory.map((story, index) => {
                const choice = gameState.choiceHistory[index];
                return `
                    <div class="history-item" onclick="viewHistoryItem(${index})">
                        <div class="history-item-title">${story.title}</div>
                        ${choice ? `<div class="history-item-choice">é€‰æ‹©: ${choice}</div>` : ''}
                        <div class="history-item-age">${story.age}å²æ—¶</div>
                    </div>
                `;
            }).join('');
            
            historyContent.innerHTML = historyHTML;
        }
        
        // æŸ¥çœ‹å†å²äº‹ä»¶è¯¦æƒ…
        function viewHistoryItem(index) {
            const story = gameState.storyHistory[index];
            const choice = gameState.choiceHistory[index];
            
            const modalContent = `
                <div style="max-width: 600px; max-height: 80vh; overflow-y: auto;">
                    <h3>${story.title}</h3>
                    <p><strong>å¹´é¾„ï¼š</strong>${story.age}å²</p>
                    <div style="margin: 15px 0; padding: 15px; background: #f8f9fa; border-radius: 8px;">
                        ${marked.parse(story.story)}
                    </div>
                    ${choice ? `<p><strong>æ‚¨çš„é€‰æ‹©ï¼š</strong>${choice}</p>` : ''}
                    <div style="margin-top: 20px; display: flex; gap: 10px;">
                        <button onclick="closeHistoryModal()" style="background: #6c5ce7; color: white; border: none; padding: 10px 20px; border-radius: 5px; cursor: pointer;">å…³é—­</button>
                        ${choice ? `<button onclick="modifyChoice(${index})" style="background: #e17055; color: white; border: none; padding: 10px 20px; border-radius: 5px; cursor: pointer;">ä¿®æ”¹é€‰æ‹©</button>` : ''}
                    </div>
                </div>
            `;
            
            showModal('å†å²å›é¡¾', modalContent);
        }
        
        // æ˜¾ç¤ºæ¨¡æ€æ¡†
        function showModal(title, content) {
            const modal = document.createElement('div');
            modal.id = 'historyModal';
            modal.style.cssText = `
                position: fixed; top: 0; left: 0; width: 100%; height: 100%;
                background: rgba(0,0,0,0.8); z-index: 2000;
                display: flex; align-items: center; justify-content: center;
                padding: 20px;
            `;
            
            modal.innerHTML = `
                <div style="background: white; border-radius: 15px; padding: 30px; position: relative;">
                    <h2 style="margin-bottom: 20px; color: #333;">${title}</h2>
                    ${content}
                </div>
            `;
            
            document.body.appendChild(modal);
            
            // ç‚¹å‡»èƒŒæ™¯å…³é—­
            modal.addEventListener('click', function(e) {
                if (e.target === modal) {
                    closeHistoryModal();
                }
            });
        }
        
        // å…³é—­å†å²æ¨¡æ€æ¡†
        function closeHistoryModal() {
            const modal = document.getElementById('historyModal');
            if (modal) {
                modal.remove();
            }
        }
        
        // å…³é—­é˜¶æ®µæ¨¡æ€æ¡†
        function closeStageModal() {
            const modal = document.getElementById('historyModal');
            if (modal) {
                modal.remove();
            }
        }
        
        // ä¿®æ”¹å†å²é€‰æ‹©
        function modifyChoice(eventIndex) {
            if (confirm('ç¡®å®šè¦ä¿®æ”¹è¿™ä¸ªé€‰æ‹©å—ï¼Ÿè¿™å°†é‡ç½®åç»­æ‰€æœ‰äº‹ä»¶ï¼Œæ¸¸æˆå°†ä»æ­¤èŠ‚ç‚¹é‡æ–°å¼€å§‹ã€‚')) {
                closeHistoryModal();
                
                // é‡ç½®æ¸¸æˆçŠ¶æ€åˆ°æŒ‡å®šäº‹ä»¶ä¹‹å‰
                const targetEvent = gameState.storyHistory[eventIndex];
                
                // ä¿ç•™åˆ°æŒ‡å®šäº‹ä»¶çš„æ‰€æœ‰çŠ¶æ€
                gameState.storyHistory = gameState.storyHistory.slice(0, eventIndex + 1);
                gameState.choiceHistory = gameState.choiceHistory.slice(0, eventIndex);
                
                // æ¢å¤åˆ°è¯¥äº‹ä»¶æ—¶çš„çŠ¶æ€
                gameState.currentAge = targetEvent.age;
                gameState.eventCount = eventIndex;
                
                // é‡æ–°è®¡ç®—å‘½è¿å€¼ï¼ˆåŸºäºä¿ç•™çš„é€‰æ‹©ï¼‰
                gameState.destinyScore = 100;
                for (let i = 0; i < gameState.choiceHistory.length; i++) {
                    // è¿™é‡Œç®€åŒ–å¤„ç†ï¼Œå®é™…åº”è¯¥è®°å½•æ¯ä¸ªé€‰æ‹©çš„å½±å“å€¼
                    const randomImpact = Math.floor(Math.random() * 6) - 2; // -2 åˆ° +3
                    gameState.destinyScore += randomImpact;
                }
                
                // æ›´æ–°æ˜¾ç¤º
                updateGameStats();
                updateCurrentStage();
                updateHistoryDisplay();
                updateStageEventCounts();
                
                // é‡æ–°ç”Ÿæˆè¯¥äº‹ä»¶çš„é€‰æ‹©
                restoreEventChoices(targetEvent, eventIndex);
            }
        }
        
        // æ¢å¤äº‹ä»¶é€‰æ‹©ç•Œé¢
        function restoreEventChoices(storyData, eventIndex) {
            // æ˜¾ç¤ºæ•…äº‹
            document.getElementById('gameSettings').style.display = 'none';
            document.getElementById('storySection').style.display = 'block';
            document.getElementById('storyTitle').textContent = storyData.title;
            document.getElementById('storyContent').innerHTML = `
                <div style="padding: 20px; line-height: 1.8;">
                    ${marked.parse(storyData.story)}
                </div>
            `;
            
            // é‡æ–°ç”Ÿæˆé€‰æ‹©ï¼ˆæ¨¡æ‹ŸåŸå§‹é€‰æ‹©ï¼‰
            const choices = [
                {
                    text: "ç§¯æåº”å¯¹ï¼Œå¯»æ±‚æœ€ä½³è§£å†³æ–¹æ¡ˆ",
                    consequence: "å¯èƒ½å¸¦æ¥æ­£é¢å½±å“",
                    destiny_impact: Math.floor(Math.random() * 6) + 2
                },
                {
                    text: "è°¨æ…å¤„ç†ï¼Œé¿å…å†’é™©",
                    consequence: "ä¿æŒç°çŠ¶ï¼Œå°å¹…æ”¹å–„",
                    destiny_impact: Math.floor(Math.random() * 4) - 1
                },
                {
                    text: "éšé‡è€Œå®‰ï¼Œé¡ºå…¶è‡ªç„¶",
                    consequence: "å½±å“ä¸ç¡®å®š",
                    destiny_impact: Math.floor(Math.random() * 4) - 2
                },
                {
                    text: "å¦è¾Ÿè¹Šå¾„ï¼Œå¯»æ‰¾æ–°æœºä¼š",
                    consequence: "æœ‰é£é™©ä½†å¯èƒ½æœ‰å›æŠ¥",
                    destiny_impact: Math.floor(Math.random() * 8) - 3
                }
            ];
            
            // éšæœºé€‰æ‹©2-4ä¸ªé€‰é¡¹
            const choiceCount = Math.floor(Math.random() * 3) + 2;
            const selectedChoices = choices.sort(() => Math.random() - 0.5).slice(0, choiceCount);
            
            const choicesSection = document.getElementById('choicesSection');
            const choicesList = document.getElementById('choicesList');
            
            choicesList.innerHTML = selectedChoices.map((choice, index) => {
                const choiceId = `restore_choice_${Date.now()}_${index}`;
                const safeText = choice.text.replace(/'/g, "\\'").replace(/"/g, '\\"');
                const safeTitle = storyData.title.replace(/'/g, "\\'").replace(/"/g, '\\"');
                return `
                    <button class="choice-button" id="${choiceId}" onclick="makeChoice(${index}, '${safeText}', ${choice.destiny_impact}, '${safeTitle}', '${choiceId}')">
                        <span class="choice-number">${index + 1}</span>
                        ${choice.text}
                        <br>
                        <small style="opacity: 0.8; margin-left: 35px;">é¢„æœŸå½±å“: ${choice.consequence}</small>
                    </button>
                `;
            }).join('');
            
            choicesSection.style.display = 'block';
        }
        
        // ç»“æŸæ¸¸æˆå¹¶ç”Ÿæˆå®Œæ•´æ•…äº‹æ€»ç»“
        async function endGame() {
            try {
                // æ£€æŸ¥AIé…ç½®
                if (!aiConfig || !aiConfig.api_key) {
                    alert('éœ€è¦é…ç½®AIæ‰èƒ½ç”Ÿæˆäººç”Ÿæ€»ç»“');
                    return;
                }
                
                // æ˜¾ç¤ºåŠ è½½çŠ¶æ€
                document.getElementById('choicesSection').style.display = 'none';
                document.getElementById('storyContent').innerHTML = `
                    <div class="loading">
                        <div class="loading-spinner"></div>
                        æ­£åœ¨ç”Ÿæˆæ‚¨çš„äººç”Ÿæ€»ç»“å’Œç›–æ£ºå®šè®º...
                    </div>
                `;
                
                // æ„å»ºæ€»ç»“æç¤ºè¯
                const summaryPrompt = buildSummaryPrompt();
                
                // è°ƒç”¨AIç”Ÿæˆæ€»ç»“
                const response = await fetch('/api/destiny-story-stream', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        prompt: summaryPrompt,
                        ai_config: aiConfig,
                        game_state: gameState
                    })
                });
                
                if (!response.ok) {
                    throw new Error(`HTTPé”™è¯¯: ${response.status}`);
                }
                
                // å¤„ç†æµå¼å“åº”
                const reader = response.body.getReader();
                const decoder = new TextDecoder();
                let fullContent = '';
                
                // åˆå§‹åŒ–æµå¼æ˜¾ç¤º
                document.getElementById('storyContent').innerHTML = `
                    <div style="padding: 20px;">
                        <h2 style="color: #667eea; text-align: center; margin-bottom: 30px;">ğŸ“œ äººç”Ÿæ€»ç»“</h2>
                        <div id="summaryContent" style="line-height: 1.8; white-space: pre-wrap;"></div>
                        <span id="summaryCursor" style="background: #ffd700; color: #f093fb; padding: 2px 4px; animation: blink 1s infinite;">|</span>
                    </div>
                `;
                
                const summaryContentDiv = document.getElementById('summaryContent');
                const summaryCursor = document.getElementById('summaryCursor');
                
                while (true) {
                    const { done, value } = await reader.read();
                    
                    if (done) {
                        break;
                    }
                    
                    const chunk = decoder.decode(value, { stream: true });
                    const lines = chunk.split('\n');
                    
                    for (const line of lines) {
                        if (line.startsWith('data: ')) {
                            const data = line.slice(6);
                            if (data.trim() === '') continue;
                            
                            try {
                                const parsed = JSON.parse(data);
                                
                                if (parsed.error) {
                                    throw new Error(parsed.error);
                                }
                                
                                if (parsed.content) {
                                    fullContent += parsed.content;
                                    summaryContentDiv.textContent = fullContent;
                                }
                                
                                if (parsed.done) {
                                    summaryCursor.style.display = 'none';
                                    
                                    // æ·»åŠ é‡æ–°å¼€å§‹æŒ‰é’®
                                    setTimeout(() => {
                                        summaryContentDiv.innerHTML += `
                                            <div style="text-align: center; margin-top: 30px; padding-top: 20px; border-top: 2px solid #eee;">
                                                <button onclick="resetGame()" style="background: linear-gradient(45deg, #667eea, #764ba2); color: white; border: none; padding: 15px 30px; border-radius: 8px; cursor: pointer; font-size: 1.1em; margin-right: 15px;">
                                                    ğŸ”„ é‡æ–°å¼€å§‹äººç”Ÿ
                                                </button>
                                                <button onclick="window.close()" style="background: linear-gradient(45deg, #ff6b6b, #ee5a24); color: white; border: none; padding: 15px 30px; border-radius: 8px; cursor: pointer; font-size: 1.1em;">
                                                    ğŸ  è¿”å›ä¸»é¡µ
                                                </button>
                                            </div>
                                        `;
                                    }, 2000);
                                    break;
                                }
                            } catch (e) {
                                console.error('è§£æJSONé”™è¯¯:', e);
                                continue;
                            }
                        }
                    }
                }
                
            } catch (error) {
                console.error('ç”Ÿæˆäººç”Ÿæ€»ç»“å¤±è´¥:', error);
                document.getElementById('storyContent').innerHTML = `
                    <div style="color: #ff6b6b; text-align: center; padding: 20px;">
                        âŒ ç”Ÿæˆäººç”Ÿæ€»ç»“å¤±è´¥: ${error.message}
                        <br><br>
                        <button onclick="endGame()" style="background: #6c5ce7; color: white; border: none; padding: 10px 20px; border-radius: 5px; cursor: pointer;">
                            ğŸ”„ é‡è¯•
                        </button>
                    </div>
                `;
            }
        }
        
        // æ„å»ºæ€»ç»“æç¤ºè¯
        function buildSummaryPrompt() {
            const birthInfo = gameState.baziData.birth_info;
            const baziAnalysis = gameState.baziData.bazi_analysis;
            
            // ç»„ç»‡äººç”Ÿäº‹ä»¶
            const lifeEvents = gameState.storyHistory.map((story, index) => {
                const choice = gameState.choiceHistory[index];
                return `**${story.age}å² - ${story.title}**\n${story.story}\n${choice ? `é€‰æ‹©ï¼š${choice}` : ''}`;
            }).join('\n\n');
            
            return `ä½ æ˜¯ä¸€ä½å¾·é«˜æœ›é‡çš„å‘½ç†å¤§å¸ˆï¼Œç°åœ¨éœ€è¦ä¸ºä¸€ä¸ªäººçš„å®Œæ•´äººç”Ÿåšå‡ºæ€»ç»“å’Œç›–æ£ºå®šè®ºã€‚

## åŸºæœ¬ä¿¡æ¯ï¼š
- å‡ºç”Ÿæ—¥æœŸï¼š${birthInfo.date}
- æ€§åˆ«ï¼š${birthInfo.gender}
- ç”Ÿè‚–ï¼š${birthInfo.shengxiao}

## å…«å­—åˆ†æï¼š
${baziAnalysis}

## äººç”Ÿè½¨è¿¹ï¼š
${lifeEvents}

## äººç”Ÿæ•°æ®ï¼š
- æœ€ç»ˆå¹´é¾„ï¼š${gameState.currentAge}å²
- å‘½è¿å€¼ï¼š${gameState.destinyScore}
- ç»å†äº‹ä»¶ï¼š${gameState.eventCount}ä¸ª
- æ•…äº‹é£æ ¼ï¼š${gameState.settings.storyStyle}

## ä»»åŠ¡è¦æ±‚ï¼š
è¯·åŸºäºä»¥ä¸Šä¿¡æ¯ï¼Œå†™ä¸€ç¯‡æ·±åˆ»çš„äººç”Ÿæ€»ç»“ï¼ŒåŒ…å«ï¼š

1. **äººç”Ÿå›é¡¾**ï¼šæ€»ç»“è¿™ä¸ªäººçš„ä¸»è¦äººç”Ÿé˜¶æ®µå’Œå…³é”®äº‹ä»¶
2. **æ€§æ ¼ç‰¹ç‚¹**ï¼šåŸºäºå…«å­—åˆ†æå’Œäººç”Ÿé€‰æ‹©ï¼Œåˆ†æå…¶æ€§æ ¼ç‰¹å¾
3. **æˆå°±ä¸é—æ†¾**ï¼šå®¢è§‚è¯„ä»·äººç”Ÿçš„æˆåŠŸå’Œä¸è¶³
4. **äººç”Ÿæ„Ÿæ‚Ÿ**ï¼šä»å‘½ç†è§’åº¦åˆ†æäººç”Ÿçš„å› æœå…³ç³»
5. **ç›–æ£ºå®šè®º**ï¼šç»™å‡ºæœ€ç»ˆçš„äººç”Ÿè¯„ä»·å’Œå¯ç¤º

## å†™ä½œè¦æ±‚ï¼š
- è¯­è¨€ä¼˜ç¾ï¼Œå¯Œæœ‰å“²ç†
- ç»“åˆå‘½ç†å­¦çŸ¥è¯†ï¼Œä½“ç°å› æœå…³ç³»
- æ—¢è¦å®¢è§‚å…¬æ­£ï¼Œåˆè¦å……æ»¡äººæ–‡å…³æ€€
- ç¯‡å¹…é€‚ä¸­ï¼Œçº¦500-800å­—
- ä»¥ç¬¬ä¸‰äººç§°å™è¿°ï¼Œè¯­è°ƒåº„é‡è€Œæ¸©æš–

è¯·ä»¥çº¯æ–‡æœ¬å½¢å¼è¾“å‡ºï¼Œä¸éœ€è¦JSONæ ¼å¼ã€‚`;
        }
        
        // é‡ç½®æ¸¸æˆ
        function resetGame() {
            if (confirm('ç¡®å®šè¦é‡æ–°å¼€å§‹æ¸¸æˆå—ï¼Ÿæ‰€æœ‰è¿›åº¦å°†ä¸¢å¤±ã€‚')) {
                gameState = {
                    baziData: gameState.baziData, // ä¿ç•™å…«å­—æ•°æ®
                    currentAge: 0,
                    currentStage: 'ç«¥å¹´',
                    destinyScore: 100,
                    eventCount: 0,
                    choiceHistory: [],
                    storyHistory: [],
                    settings: gameState.settings // ä¿ç•™æ¸¸æˆè®¾ç½®
                };
                
                updateGameStats();
                generateLifeStages();
                updateHistoryDisplay();
                
                // æ˜¾ç¤ºè®¾ç½®ç•Œé¢ï¼Œé‡æ–°é€‰æ‹©
                document.getElementById('gameSettings').style.display = 'block';
                document.getElementById('storySection').style.display = 'none';
                document.getElementById('choicesSection').style.display = 'none';
            }
        }
        
        // é¡µé¢åŠ è½½å®Œæˆååˆå§‹åŒ–æ¸¸æˆ
        window.addEventListener('load', function() {
            console.log('é¡µé¢åŠ è½½å®Œæˆï¼Œå¼€å§‹åˆå§‹åŒ–æ¸¸æˆ...');
            initGame();
        });

    </script>
</body>
</html>